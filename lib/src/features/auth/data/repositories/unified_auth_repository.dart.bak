import 'dart:convert';
import 'package:crypto/crypto.dart';
import 'package:firebase_auth/firebase_auth.dart' as firebase_auth;
import 'package:google_sign_in/google_sign_in.dart';
import 'package:flutter_facebook_auth/flutter_facebook_auth.dart';
import 'package:kakao_flutter_sdk/kakao_flutter_sdk.dart' as kakao;
import 'package:logger/logger.dart';

import '../../domain/repositories/auth_repository.dart';
import '../../domain/models/auth_user.dart';

class UnifiedAuthRepository implements AuthRepository {
  final firebase_auth.FirebaseAuth _firebaseAuth = firebase_auth.FirebaseAuth.instance;
  final GoogleSignIn _googleSignIn = GoogleSignIn(
    scopes: ['email', 'profile'],
  );
  final FacebookAuth _facebookAuth = FacebookAuth.instance;
  final Logger _logger = Logger();

  @override
  Future<AuthUser?> signInWithEmail(String email, String password) async {
    try {
      _logger.i('ğŸ“§ [AUTH] Attempting email sign in for: $email');
      
      final credential = await _firebaseAuth.signInWithEmailAndPassword(
        email: email,
        password: password,
      );

      if (credential.user != null) {
        final authUser = AuthUser.fromFirebaseUser(credential.user!, AuthProvider.email);
        _logger.i('âœ… [AUTH] Email sign in successful');
        return authUser;
      }
      
      return null;
    } on firebase_auth.FirebaseAuthException catch (e) {
      _logger.e('âŒ [AUTH] Email sign in failed: ${e.code} - ${e.message}');
      throw _handleFirebaseAuthException(e);
    } catch (e) {
      _logger.e('âŒ [AUTH] Email sign in error: $e');
      throw Exception('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: $e');
    }
  }

  @override
  Future<AuthUser?> signUpWithEmail(String email, String password, String displayName) async {
    try {
      _logger.i('ğŸ“§ [AUTH] Attempting email sign up for: $email');
      
      final credential = await _firebaseAuth.createUserWithEmailAndPassword(
        email: email,
        password: password,
      );

      if (credential.user != null) {
        // ì‚¬ìš©ì ì´ë¦„ ì—…ë°ì´íŠ¸
        await credential.user!.updateDisplayName(displayName);
        await credential.user!.reload();
        
        // ì´ë©”ì¼ ì¸ì¦ ë©”ì¼ ë°œì†¡
        await credential.user!.sendEmailVerification();
        
        final updatedUser = _firebaseAuth.currentUser;
        if (updatedUser != null) {
          final authUser = AuthUser.fromFirebaseUser(updatedUser, AuthProvider.email);
          _logger.i('âœ… [AUTH] Email sign up successful');
          return authUser;
        }
      }
      
      return null;
    } on firebase_auth.FirebaseAuthException catch (e) {
      _logger.e('âŒ [AUTH] Email sign up failed: ${e.code} - ${e.message}');
      throw _handleFirebaseAuthException(e);
    } catch (e) {
      _logger.e('âŒ [AUTH] Email sign up error: $e');
      throw Exception('íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: $e');
    }
  }

  @override
  Future<AuthUser?> signInWithGoogle() async {
    try {
      _logger.i('ğŸ” [AUTH] Attempting Google sign in');
      
      // Google ë¡œê·¸ì¸ ì‹œì‘
      final GoogleSignInAccount? googleUser = await _googleSignIn.signIn();
      if (googleUser == null) {
        _logger.w('âš ï¸ [AUTH] Google sign in cancelled by user');
        return null;
      }

      // Google ì¸ì¦ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      final GoogleSignInAuthentication googleAuth = await googleUser.authentication;

      // Firebase ìê²© ì¦ëª… ìƒì„±
      final credential = firebase_auth.GoogleAuthProvider.credential(
        accessToken: googleAuth.accessToken,
        idToken: googleAuth.idToken,
      );

      // Firebaseì— ë¡œê·¸ì¸
      final firebase_auth.UserCredential userCredential = 
          await _firebaseAuth.signInWithCredential(credential);

      if (userCredential.user != null) {
        final authUser = AuthUser.fromFirebaseUser(userCredential.user!, AuthProvider.google);
        _logger.i('âœ… [AUTH] Google sign in successful');
        return authUser;
      }
      
      return null;
    } catch (e) {
      _logger.e('âŒ [AUTH] Google sign in error: $e');
      await _googleSignIn.signOut();
      throw Exception('Google ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: $e');
    }
  }

  @override
  Future<AuthUser?> signInWithFacebook() async {
    try {
      _logger.i('ğŸ“˜ [AUTH] Attempting Facebook sign in');
      
      // Facebook ë¡œê·¸ì¸
      final LoginResult result = await _facebookAuth.login();
      
      if (result.status == LoginStatus.success) {
        final AccessToken accessToken = result.accessToken!;
        
        // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        final userData = await _facebookAuth.getUserData();
        
        // Firebase ìê²© ì¦ëª… ìƒì„±
        final credential = firebase_auth.FacebookAuthProvider.credential(accessToken.tokenString);
        
        // Firebaseì— ë¡œê·¸ì¸
        final firebase_auth.UserCredential userCredential = 
            await _firebaseAuth.signInWithCredential(credential);

        if (userCredential.user != null) {
          final authUser = AuthUser.fromFirebaseUser(userCredential.user!, AuthProvider.facebook);
          _logger.i('âœ… [AUTH] Facebook sign in successful');
          return authUser;
        }
      } else if (result.status == LoginStatus.cancelled) {
        _logger.w('âš ï¸ [AUTH] Facebook sign in cancelled by user');
        return null;
      } else {
        throw Exception('Facebook ë¡œê·¸ì¸ ì‹¤íŒ¨: ${result.message}');
      }
      
      return null;
    } catch (e) {
      _logger.e('âŒ [AUTH] Facebook sign in error: $e');
      throw Exception('Facebook ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: $e');
    }
  }

  @override
  Future<AuthUser?> signInWithKakao() async {
    try {
      _logger.i('ğŸ’¬ [AUTH] Attempting Kakao sign in');
      
      // ì¹´ì¹´ì˜¤í†¡ ì„¤ì¹˜ ì—¬ë¶€ í™•ì¸
      if (await kakao.isKakaoTalkInstalled()) {
        try {
          await kakao.UserApi.instance.loginWithKakaoTalk();
          _logger.i('ğŸ“± [AUTH] Kakao login via KakaoTalk app');
        } catch (error) {
          _logger.w('âš ï¸ [AUTH] KakaoTalk login failed, trying web login: $error');
          if (error is kakao.PlatformException && error.code == 'CANCELED') {
            _logger.w('âš ï¸ [AUTH] Kakao login cancelled by user');
            return null;
          }
          // ì¹´ì¹´ì˜¤í†¡ ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‹œ ì›¹ ë¡œê·¸ì¸ ì‹œë„
          await kakao.UserApi.instance.loginWithKakaoAccount();
          _logger.i('ğŸŒ [AUTH] Kakao login via web');
        }
      } else {
        await kakao.UserApi.instance.loginWithKakaoAccount();
        _logger.i('ğŸŒ [AUTH] Kakao login via web (KakaoTalk not installed)');
      }

      // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      final kakao.User user = await kakao.UserApi.instance.me();
      
      final authUser = AuthUser.fromKakaoUser(user);
      _logger.i('âœ… [AUTH] Kakao sign in successful');
      return authUser;
      
    } catch (error) {
      _logger.e('âŒ [AUTH] Kakao sign in error: $error');
      throw Exception('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: $error');
    }
  }

  @override
  Future<void> resetPassword(String email) async {
    try {
      _logger.i('ğŸ” [AUTH] Sending password reset email to: $email');
      await _firebaseAuth.sendPasswordResetEmail(email: email);
      _logger.i('âœ… [AUTH] Password reset email sent successfully');
    } on firebase_auth.FirebaseAuthException catch (e) {
      _logger.e('âŒ [AUTH] Password reset failed: ${e.code} - ${e.message}');
      throw _handleFirebaseAuthException(e);
    }
  }

  @override
  Future<AuthUser?> getCurrentUser() async {
    try {
      final firebaseUser = _firebaseAuth.currentUser;
      if (firebaseUser != null) {
        // Firebase ì‚¬ìš©ìì¸ ê²½ìš°
        return AuthUser.fromFirebaseUser(firebaseUser, AuthProvider.email);
      }

      // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í™•ì¸
      try {
        final token = await kakao.TokenManagerProvider.instance.manager.getToken();
        if (token != null) {
          final kakaoUser = await kakao.UserApi.instance.me();
          return AuthUser.fromKakaoUser(kakaoUser);
        }
      } catch (e) {
        _logger.d('No Kakao user found: $e');
      }

      return null;
    } catch (e) {
      _logger.e('âŒ [AUTH] Error getting current user: $e');
      return null;
    }
  }

  @override
  Future<void> signOut() async {
    try {
      _logger.i('ğŸšª [AUTH] Signing out all accounts');
      
      // Firebase ë¡œê·¸ì•„ì›ƒ
      await _firebaseAuth.signOut();
      
      // Google ë¡œê·¸ì•„ì›ƒ
      await _googleSignIn.signOut();
      
      // Facebook ë¡œê·¸ì•„ì›ƒ
      await _facebookAuth.logOut();
      
      // ì¹´ì¹´ì˜¤ ë¡œê·¸ì•„ì›ƒ
      try {
        await kakao.UserApi.instance.logout();
      } catch (e) {
        _logger.d('Kakao logout error (may not be logged in): $e');
      }
      
      _logger.i('âœ… [AUTH] Sign out completed');
    } catch (e) {
      _logger.e('âŒ [AUTH] Sign out error: $e');
      throw Exception('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: $e');
    }
  }

  @override
  Future<void> updateDisplayName(String displayName) async {
    try {
      final user = _firebaseAuth.currentUser;
      if (user != null) {
        await user.updateDisplayName(displayName);
        await user.reload();
        _logger.i('âœ… [AUTH] Display name updated successfully');
      }
    } catch (e) {
      _logger.e('âŒ [AUTH] Error updating display name: $e');
      throw Exception('ì‚¬ìš©ì ì´ë¦„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: $e');
    }
  }

  @override
  Future<void> updatePhotoURL(String photoURL) async {
    try {
      final user = _firebaseAuth.currentUser;
      if (user != null) {
        await user.updatePhotoURL(photoURL);
        await user.reload();
        _logger.i('âœ… [AUTH] Photo URL updated successfully');
      }
    } catch (e) {
      _logger.e('âŒ [AUTH] Error updating photo URL: $e');
      throw Exception('í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: $e');
    }
  }

  @override
  Stream<AuthUser?> authStateChanges() {
    return _firebaseAuth.authStateChanges().map((firebaseUser) {
      if (firebaseUser != null) {
        return AuthUser.fromFirebaseUser(firebaseUser, AuthProvider.email);
      }
      return null;
    });
  }

  // Firebase Auth ì˜ˆì™¸ ì²˜ë¦¬
  Exception _handleFirebaseAuthException(firebase_auth.FirebaseAuthException e) {
    switch (e.code) {
      case 'user-not-found':
        return Exception('ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.');
      case 'wrong-password':
        return Exception('ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.');
      case 'email-already-in-use':
        return Exception('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.');
      case 'weak-password':
        return Exception('ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤.');
      case 'invalid-email':
        return Exception('ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.');
      case 'user-disabled':
        return Exception('ë¹„í™œì„±í™”ëœ ê³„ì •ì…ë‹ˆë‹¤.');
      case 'too-many-requests':
        return Exception('ë„ˆë¬´ ë§ì€ ìš”ì²­ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      case 'operation-not-allowed':
        return Exception('í˜„ì¬ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ë¡œê·¸ì¸ ë°©ì‹ì…ë‹ˆë‹¤.');
      default:
        return Exception('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}');
    }
  }
}
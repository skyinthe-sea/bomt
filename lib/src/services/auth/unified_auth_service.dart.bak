import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:logger/logger.dart';

import '../../features/auth/domain/repositories/auth_repository.dart';
import '../../features/auth/domain/models/auth_user.dart';
import '../../features/auth/data/repositories/unified_auth_repository.dart';

class UnifiedAuthService {
  static UnifiedAuthService? _instance;
  static UnifiedAuthService get instance => _instance ??= UnifiedAuthService._();
  
  UnifiedAuthService._();

  final AuthRepository _authRepository = UnifiedAuthRepository();
  final Logger _logger = Logger();
  
  // SharedPreferences keys
  static const String _autoLoginKey = 'auto_login_enabled';
  static const String _lastAuthUserKey = 'last_auth_user';
  static const String _lastAuthProviderKey = 'last_auth_provider';

  AuthUser? _currentUser;
  SharedPreferences? _prefs;

  /// ì´ˆê¸°í™”
  Future<void> initialize() async {
    _prefs = await SharedPreferences.getInstance();
    _logger.i('ğŸ”§ [AUTH_SERVICE] Initialized');
  }

  /// í˜„ì¬ ì‚¬ìš©ì
  AuthUser? get currentUser => _currentUser;

  /// ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
  bool get isLoggedIn => _currentUser != null;

  /// ìë™ ë¡œê·¸ì¸ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
  bool getAutoLogin() {
    return _prefs?.getBool(_autoLoginKey) ?? false;
  }

  /// ìë™ ë¡œê·¸ì¸ ì„¤ì •
  Future<void> setAutoLogin(bool enabled) async {
    await _prefs?.setBool(_autoLoginKey, enabled);
    _logger.i('âš™ï¸ [AUTH_SERVICE] Auto login set to: $enabled');
  }

  /// ì´ë©”ì¼ ë¡œê·¸ì¸
  Future<AuthUser?> signInWithEmail(String email, String password) async {
    try {
      _logger.i('ğŸ“§ [AUTH_SERVICE] Email sign in attempt');
      final user = await _authRepository.signInWithEmail(email, password);
      if (user != null) {
        _currentUser = user;
        await _saveLastAuthUser(user);
        _logger.i('âœ… [AUTH_SERVICE] Email sign in successful');
      }
      return user;
    } catch (e) {
      _logger.e('âŒ [AUTH_SERVICE] Email sign in failed: $e');
      rethrow;
    }
  }

  /// ì´ë©”ì¼ íšŒì›ê°€ì…
  Future<AuthUser?> signUpWithEmail(String email, String password, String displayName) async {
    try {
      _logger.i('ğŸ“§ [AUTH_SERVICE] Email sign up attempt');
      final user = await _authRepository.signUpWithEmail(email, password, displayName);
      if (user != null) {
        _currentUser = user;
        await _saveLastAuthUser(user);
        _logger.i('âœ… [AUTH_SERVICE] Email sign up successful');
      }
      return user;
    } catch (e) {
      _logger.e('âŒ [AUTH_SERVICE] Email sign up failed: $e');
      rethrow;
    }
  }

  /// êµ¬ê¸€ ë¡œê·¸ì¸
  Future<AuthUser?> signInWithGoogle() async {
    try {
      _logger.i('ğŸ” [AUTH_SERVICE] Google sign in attempt');
      final user = await _authRepository.signInWithGoogle();
      if (user != null) {
        _currentUser = user;
        await _saveLastAuthUser(user);
        _logger.i('âœ… [AUTH_SERVICE] Google sign in successful');
      }
      return user;
    } catch (e) {
      _logger.e('âŒ [AUTH_SERVICE] Google sign in failed: $e');
      rethrow;
    }
  }

  /// í˜ì´ìŠ¤ë¶ ë¡œê·¸ì¸
  Future<AuthUser?> signInWithFacebook() async {
    try {
      _logger.i('ğŸ“˜ [AUTH_SERVICE] Facebook sign in attempt');
      final user = await _authRepository.signInWithFacebook();
      if (user != null) {
        _currentUser = user;
        await _saveLastAuthUser(user);
        _logger.i('âœ… [AUTH_SERVICE] Facebook sign in successful');
      }
      return user;
    } catch (e) {
      _logger.e('âŒ [AUTH_SERVICE] Facebook sign in failed: $e');
      rethrow;
    }
  }

  /// ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸
  Future<AuthUser?> signInWithKakao() async {
    try {
      _logger.i('ğŸ’¬ [AUTH_SERVICE] Kakao sign in attempt');
      final user = await _authRepository.signInWithKakao();
      if (user != null) {
        _currentUser = user;
        await _saveLastAuthUser(user);
        _logger.i('âœ… [AUTH_SERVICE] Kakao sign in successful');
      }
      return user;
    } catch (e) {
      _logger.e('âŒ [AUTH_SERVICE] Kakao sign in failed: $e');
      rethrow;
    }
  }

  /// ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •
  Future<void> resetPassword(String email) async {
    try {
      _logger.i('ğŸ” [AUTH_SERVICE] Password reset request for: $email');
      await _authRepository.resetPassword(email);
      _logger.i('âœ… [AUTH_SERVICE] Password reset email sent');
    } catch (e) {
      _logger.e('âŒ [AUTH_SERVICE] Password reset failed: $e');
      rethrow;
    }
  }

  /// ìë™ ë¡œê·¸ì¸ í™•ì¸
  Future<AuthUser?> tryAutoLogin() async {
    try {
      if (!getAutoLogin()) {
        _logger.d('ğŸ” [AUTH_SERVICE] Auto login disabled');
        return null;
      }

      _logger.i('ğŸ” [AUTH_SERVICE] Checking auto login');
      
      // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      final user = await _authRepository.getCurrentUser();
      if (user != null) {
        _currentUser = user;
        await _saveLastAuthUser(user);
        _logger.i('âœ… [AUTH_SERVICE] Auto login successful');
        return user;
      }

      _logger.w('âš ï¸ [AUTH_SERVICE] No valid session found');
      return null;
    } catch (e) {
      _logger.e('âŒ [AUTH_SERVICE] Auto login failed: $e');
      return null;
    }
  }

  /// ë¡œê·¸ì•„ì›ƒ
  Future<void> signOut() async {
    try {
      _logger.i('ğŸšª [AUTH_SERVICE] Starting sign out');
      
      await _authRepository.signOut();
      _currentUser = null;
      
      // ìë™ ë¡œê·¸ì¸ ë¹„í™œì„±í™”
      await setAutoLogin(false);
      
      // ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ ì‚­ì œ
      await _clearLastAuthUser();
      
      _logger.i('âœ… [AUTH_SERVICE] Sign out completed');
    } catch (e) {
      _logger.e('âŒ [AUTH_SERVICE] Sign out failed: $e');
      rethrow;
    }
  }

  /// ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
  Future<void> updateDisplayName(String displayName) async {
    try {
      await _authRepository.updateDisplayName(displayName);
      if (_currentUser != null) {
        _currentUser = _currentUser!.copyWith(displayName: displayName);
        await _saveLastAuthUser(_currentUser!);
      }
      _logger.i('âœ… [AUTH_SERVICE] Display name updated');
    } catch (e) {
      _logger.e('âŒ [AUTH_SERVICE] Display name update failed: $e');
      rethrow;
    }
  }

  /// í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
  Future<void> updatePhotoURL(String photoURL) async {
    try {
      await _authRepository.updatePhotoURL(photoURL);
      if (_currentUser != null) {
        _currentUser = _currentUser!.copyWith(photoURL: photoURL);
        await _saveLastAuthUser(_currentUser!);
      }
      _logger.i('âœ… [AUTH_SERVICE] Photo URL updated');
    } catch (e) {
      _logger.e('âŒ [AUTH_SERVICE] Photo URL update failed: $e');
      rethrow;
    }
  }

  /// ì¸ì¦ ìƒíƒœ ìŠ¤íŠ¸ë¦¼
  Stream<AuthUser?> authStateChanges() {
    return _authRepository.authStateChanges();
  }

  /// ë§ˆì§€ë§‰ ì¸ì¦ ì œê³µì ê°€ì ¸ì˜¤ê¸°
  AuthProvider? getLastAuthProvider() {
    final providerName = _prefs?.getString(_lastAuthProviderKey);
    if (providerName != null) {
      return AuthProvider.values.firstWhere(
        (e) => e.name == providerName,
        orElse: () => AuthProvider.email,
      );
    }
    return null;
  }

  /// ë§ˆì§€ë§‰ ì‚¬ìš©ì ì •ë³´ ì €ì¥
  Future<void> _saveLastAuthUser(AuthUser user) async {
    try {
      await _prefs?.setString(_lastAuthUserKey, jsonEncode(user.toJson()));
      await _prefs?.setString(_lastAuthProviderKey, user.provider.name);
      _logger.d('ğŸ’¾ [AUTH_SERVICE] Last auth user saved');
    } catch (e) {
      _logger.e('âŒ [AUTH_SERVICE] Failed to save last auth user: $e');
    }
  }

  /// ë§ˆì§€ë§‰ ì‚¬ìš©ì ì •ë³´ ì‚­ì œ
  Future<void> _clearLastAuthUser() async {
    try {
      await _prefs?.remove(_lastAuthUserKey);
      await _prefs?.remove(_lastAuthProviderKey);
      _logger.d('ğŸ—‘ï¸ [AUTH_SERVICE] Last auth user cleared');
    } catch (e) {
      _logger.e('âŒ [AUTH_SERVICE] Failed to clear last auth user: $e');
    }
  }

  /// ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  AuthUser? getLastAuthUser() {
    try {
      final userJson = _prefs?.getString(_lastAuthUserKey);
      if (userJson != null) {
        final userData = jsonDecode(userJson) as Map<String, dynamic>;
        return AuthUser.fromJson(userData);
      }
    } catch (e) {
      _logger.e('âŒ [AUTH_SERVICE] Failed to get last auth user: $e');
    }
    return null;
  }

  /// í˜„ì¬ ì‚¬ìš©ì ìƒˆë¡œê³ ì¹¨
  Future<void> refreshCurrentUser() async {
    try {
      final user = await _authRepository.getCurrentUser();
      if (user != null) {
        _currentUser = user;
        await _saveLastAuthUser(user);
        _logger.d('ğŸ”„ [AUTH_SERVICE] Current user refreshed');
      }
    } catch (e) {
      _logger.e('âŒ [AUTH_SERVICE] Failed to refresh current user: $e');
    }
  }
}